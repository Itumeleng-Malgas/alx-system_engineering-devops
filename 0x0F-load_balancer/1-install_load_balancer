#!/usr/bin/env bash

# Update the package repository
sudo apt-get update

# Install HAProxy
sudo apt-get install -y haproxy

# Function to modify HAProxy frontend and backend sections
modify_haproxy_config() {
    local haproxy_conf="/etc/haproxy/haproxy.cfg"

    # Identify the line numbers for 'global' and 'defaults'
    local start_line
    start_line=$(awk '/^global$/{print NR}' "$haproxy_conf")

    local end_line
    end_line=$(awk '/^defaults$/{print NR}' "$haproxy_conf")

    # Preserve the existing global and defaults sections
    sudo sed -n "${start_line},${end_line}p" "$haproxy_conf" | sudo tee temp_config > /dev/null

    # Create a backup by copying the original file
    sudo cp "$haproxy_conf" "$haproxy_conf.bak"
}

# Call the function to modify the HAProxy configuration
modify_haproxy_config

# Ensure HAProxy is running
sudo service haproxy restart
